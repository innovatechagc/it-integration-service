steps:
  # Paso 1: Verificar y compilar aplicaci√≥n
  - name: "golang:1.21-alpine"
    entrypoint: "sh"
    args:
      - "-c"
      - |
        apk add --no-cache git
        echo "üì¶ Descargando dependencias..."
        go mod download
        go mod tidy
        
        echo "üîç Verificando que la aplicaci√≥n compile..."
        go build -o /tmp/app .
        echo "‚úÖ Aplicaci√≥n compilada exitosamente"
        
        echo "üß™ Ejecutando tests..."
        go test ./... -v -coverprofile=coverage.out
        echo "‚úÖ Tests completados exitosamente"
    env:
      - "CGO_ENABLED=0"
      - "GOOS=linux"

  # Paso 2: Construir imagen Docker
  - name: "gcr.io/cloud-builders/docker"
    args:
      - "build"
      - "-t"
      - "gcr.io/$PROJECT_ID/${_SERVICE_NAME}:$COMMIT_SHA"
      - "-t"
      - "gcr.io/$PROJECT_ID/${_SERVICE_NAME}:latest"
      - "."

  # Paso 3: Subir imagen a Container Registry
  - name: "gcr.io/cloud-builders/docker"
    args:
      - "push"
      - "gcr.io/$PROJECT_ID/${_SERVICE_NAME}:$COMMIT_SHA"

  - name: "gcr.io/cloud-builders/docker"
    args:
      - "push"
      - "gcr.io/$PROJECT_ID/${_SERVICE_NAME}:latest"

  # Paso 4: Desplegar a producci√≥n (solo rama main/master)
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        if [[ "$BRANCH_NAME" == "main" || "$BRANCH_NAME" == "master" ]]; then
          echo "Desplegando a producci√≥n..."
          
          # Preparar configuraci√≥n
          cp deploy/cloudrun-production.yaml /tmp/cloudrun-config.yaml
          sed -i "s/PROJECT_ID/$PROJECT_ID/g" /tmp/cloudrun-config.yaml
          sed -i "s/it-integration-service:latest/${_SERVICE_NAME}:$COMMIT_SHA/g" /tmp/cloudrun-config.yaml
          
          # Desplegar
          gcloud run services replace /tmp/cloudrun-config.yaml \
            --region=${_REGION} \
            --quiet
          
          # Obtener URL del servicio
          SERVICE_URL=$$(gcloud run services describe ${_SERVICE_NAME} \
            --region=${_REGION} \
            --format="value(status.url)")
          
          echo "Servicio de producci√≥n desplegado en: $$SERVICE_URL"
          
          # Health check
          echo "Verificando servicio de producci√≥n..."
          sleep 30
          if curl -f "$$SERVICE_URL/api/v1/health" --max-time 10 --silent; then
            echo "‚úÖ Health check de producci√≥n exitoso"
          else
            echo "‚ö†Ô∏è Warning: Health check de producci√≥n fall√≥"
          fi
        else
          echo "No es rama main/master, saltando despliegue a producci√≥n"
        fi

  # Paso 5: Desplegar a staging (ramas que no sean main/master)
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        if [[ "$BRANCH_NAME" != "main" && "$BRANCH_NAME" != "master" ]]; then
          echo "Desplegando a staging..."
          
          # Preparar configuraci√≥n
          cp deploy/cloudrun-staging.yaml /tmp/cloudrun-config.yaml
          sed -i "s/PROJECT_ID/$PROJECT_ID/g" /tmp/cloudrun-config.yaml
          sed -i "s/it-integration-service:latest/${_SERVICE_NAME}:$COMMIT_SHA/g" /tmp/cloudrun-config.yaml
          
          # Desplegar
          gcloud run services replace /tmp/cloudrun-config.yaml \
            --region=${_REGION} \
            --quiet
          
          # Obtener URL del servicio
          SERVICE_URL=$$(gcloud run services describe ${_SERVICE_NAME}-staging \
            --region=${_REGION} \
            --format="value(status.url)")
          
          echo "Servicio de staging desplegado en: $$SERVICE_URL"
          
          # Health check
          echo "Verificando servicio de staging..."
          sleep 30
          if curl -f "$$SERVICE_URL/api/v1/health" --max-time 10 --silent; then
            echo "‚úÖ Health check de staging exitoso"
          else
            echo "‚ö†Ô∏è Warning: Health check de staging fall√≥"
          fi
        else
          echo "Es rama main/master, saltando despliegue a staging"
        fi

# Configuraci√≥n de substituciones
substitutions:
  _SERVICE_NAME: "it-integration-service"
  _REGION: "us-east1"

# Opciones de build
options:
  # machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
  env:
    - "DOCKER_BUILDKIT=1"

timeout: "1200s"
# Artifacts opcionales - crear bucket primero si es necesario
# artifacts:
#   objects:
#     location: 'gs://$PROJECT_ID-build-artifacts'
#     paths:
#       - 'coverage.out'
